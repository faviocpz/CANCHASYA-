{% extends 'base.html' %}

{% block content %}

<!-- Filtro -->
<div class="mt-5 me-5 ms-5">
  <div class="me-5 ms-5">
    <div class="me-5 ms-5">
      <label for="rangoDistancia" class="form-label">
        Buscar canchas en un radio de (km): <span id="distanciaSeleccionada">0</span>
      </label>
      <input type="range" id="rangoDistancia" class="form-range" min="0" max="10" step="0.5" value="0">
      <p class="text-muted me-5">Ajusta el radio para filtrar canchas cercanas.</p>
    </div>

    <div class="me-5 ms-5 mb-3">
      <label for="busquedaNombre" class="form-label">Buscar por nombre del local:</label>
      <input type="text" id="busquedaNombre" class="form-control" placeholder="Escribe el nombre...">
    </div>

    <div class="me-5 ms-5">
      <label for="deportesFiltro" class="form-label">Filtrar por deportes:</label>
      <div id="deportesFiltro" class="d-flex flex-wrap gap-2">

      </div>
    </div>

    <div class="me-5 ms-5">
      <label class="form-label">Estado de la cancha:</label>
      <div id="estadoFiltro" class="d-flex flex-row gap-3 align-items-center">
        <div class="form-check mb-0">
          <input type="checkbox" id="estadoTodos" name="estado" value="todos" checked class="form-check-input me-1">
          <label for="estadoTodos" class="form-check-label">Todos</label>
        </div>
        <div class="form-check mb-0">
          <input type="checkbox" id="estadoAbierto" name="estado" value="A" class="form-check-input me-1">
          <label for="estadoAbierto" class="form-check-label">Abierto</label>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="container mt-5">
  <div class="row" id="cards-container">
    <!--  cards dinamicos -->
  </div>
</div>


<style>
  .card {
    height: 100%;
    display: flex;
    flex-direction: column;
    border: none;
    border-radius: 12px;
    background-color: #ffffff;
    box-shadow: 0px 4px 20px rgba(0, 0, 0, 0.1);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.6);
    transition: box-shadow 0.3s ease, transform 0.3s ease;
  }

  .card-body {
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
  }

  .card:hover {
    transform: translateY(-8px);
    box-shadow: 0px 12px 32px rgba(0, 0, 0, 0.15);
  }


  .card-title {
    color: #22c90c;
    font-weight: 600;
    font-size: 22px;
    margin-bottom: 0.5rem;
  }


  .deporte {
    background-color: #c8c8c8;
    color: white;
    border-radius: 20px;
    padding: 2px 10px;
    margin-right: 1px;
  }
</style>


<!-- casi casi -->
<script>
  // --- Función para obtener hora y fecha en Perú ---
  function obtenerHoraPeru() {
    const now = new Date();
    const utc = now.getTime() + now.getTimezoneOffset() * 60000;
    const limaTime = new Date(utc + 3600000 * -5); // UTC-5 Perú
    const hora = limaTime.toTimeString().slice(0, 8);
    const fecha = limaTime.toLocaleDateString('es-PE');
    return { hora, fecha };
  }

  function obtenerSiguienteHorario(horarios, horaActualDate, anio, mes, dia) {
    const tramos = ['Mañana', 'Tarde', 'Noche'];
    for (let i = 0; i < horarios.length; i++) {
      const tramo = horarios[i];
      const [hInicio, mInicio] = tramo.inicio.split(':');
      const [hFin, mFin] = tramo.fin.split(':');

      let horaInicioDate = new Date(anio, mes - 1, dia, hInicio, mInicio);
      let horaFinDate = new Date(anio, mes - 1, dia, hFin, mFin);

      if (horaFinDate <= horaInicioDate) {
        horaFinDate.setDate(horaFinDate.getDate() + 1);
      }

      if (horaActualDate < horaInicioDate) {
        return `${tramos[i]}: ${tramo.inicio} - ${tramo.fin}`;
      }
    }

    const t = horarios[0];
    return `Mañana: ${t.inicio} - ${t.fin}`;
  }

  let localesData = [];
  let deportesData = [];

  function cargarDeportes(deportes) {
    const deportesFiltro = document.getElementById('deportesFiltro');
    deportesFiltro.innerHTML = '';

    deportesFiltro.insertAdjacentHTML('beforeend', `
      <label class="btn btn-outline-secondary active" for="deporteTodos">
        <input type="checkbox" class="btn-check" id="deporteTodos" name="deporte" value="deporteTodos" checked autocomplete="off"> Todos
      </label>
    `);

    deportes.forEach(dep => {
      deportesFiltro.insertAdjacentHTML('beforeend', `
        <label class="btn btn-outline-secondary" for="deporte${dep.idDeporte}">
          <input type="checkbox" class="btn-check" id="deporte${dep.idDeporte}" name="deporte" value="${dep.idDeporte}" autocomplete="off" checked> ${dep.Deportes}
        </label>
      `);
    });

    const checkboxTodos = document.getElementById('deporteTodos');
    const checkboxesDeportes = Array.from(document.querySelectorAll('#deportesFiltro input[name="deporte"]:not(#deporteTodos)'));

    checkboxTodos.addEventListener('change', function () {
      checkboxesDeportes.forEach(cb => {
        cb.checked = this.checked;
        cb.parentElement.classList.toggle('active', this.checked);
      });
      this.parentElement.classList.toggle('active', this.checked);
      aplicarFiltros();
    });

    checkboxesDeportes.forEach(cb => {
      cb.addEventListener('change', function () {
        this.parentElement.classList.toggle('active', this.checked);
        const todosMarcados = checkboxesDeportes.every(c => c.checked);
        checkboxTodos.checked = todosMarcados;
        checkboxTodos.parentElement.classList.toggle('active', todosMarcados);
        aplicarFiltros();
      });
    });

    checkboxTodos.dispatchEvent(new Event('change'));
  }

  function renderizarLocales(locales) {
    const container = document.getElementById('cards-container');
    container.innerHTML = '';

    if (!locales || locales.length === 0) {
      container.innerHTML = '<p>No hay canchas que coincidan con los filtros.</p>';
      return;
    }

    const { hora, fecha } = obtenerHoraPeru();
    const [horaActual, minutoActual, segundoActual] = hora.split(':');
    const [dia, mes, anio] = fecha.split('/');
    const horaActualDate = new Date(anio, mes - 1, dia, horaActual, minutoActual, segundoActual);

    locales.forEach(local => {
      const col = document.createElement('div');
      col.className = 'col-12 col-sm-6 col-md-4 col-lg-4 col-xl-3 mb-4';

      let deportesHtml = '<div class="d-flex flex-wrap justify-content-center gap-2 mb-2">';
      deportesHtml += local.Deportes.length > 0
        ? local.Deportes.map(dep => `<div class="deporte d-inline-block">${dep}</div>`).join('')
        : '<div class="deporte d-inline-block">No cuenta con deportes</div>';
      deportesHtml += '</div>';

      let estadoHorario = "Cerrado";
      let proximoHorario = "";

      if (local.horario && local.horario.includes(':')) {
        const partes = local.horario.match(/(\d{2}:\d{2})/g);
        if (partes.length >= 6) {
          const horarios = [
            { inicio: partes[0], fin: partes[1] },
            { inicio: partes[2], fin: partes[3] },
            { inicio: partes[4], fin: partes[5] }
          ];

          for (let tramo of horarios) {
            const [hInicio, mInicio] = tramo.inicio.split(':');
            const [hFin, mFin] = tramo.fin.split(':');
            const horaInicioDate = new Date(anio, mes - 1, dia, hInicio, mInicio);
            let horaFinDate = new Date(anio, mes - 1, dia, hFin, mFin);
            if (horaFinDate <= horaInicioDate) horaFinDate.setDate(horaFinDate.getDate() + 1);
            if (horaActualDate >= horaInicioDate && horaActualDate <= horaFinDate) {
              estadoHorario = "Abierto";
              break;
            }
          }

          if (estadoHorario === "Cerrado") {
            proximoHorario = obtenerSiguienteHorario(horarios, horaActualDate, anio, mes, dia);
          }
        }
      }

      col.innerHTML = `
        <a href="/local/${local.idLocal}" style="text-decoration: none; color: inherit;">
          <div class="card">
            <img src="/static/assets/img/${local.banner}" class="card-img-top w-100" style="height: 200px;" alt="${local.nombre}">
            <div class="card-body">
              ${deportesHtml}
              <h5 class="card-title">${local.nombre}</h5>
              <p class="mb-1">
                <i class="bi bi-clock-history" style="color: ${estadoHorario === 'Abierto' ? 'green' : 'red'};"></i>
                <span> ${estadoHorario}</span>
                ${estadoHorario === 'Cerrado' && proximoHorario ? `<br><small>Próximo horario turno ${proximoHorario}</small>` : ''}
              </p>
              <p class="mb-1">
                <i class="bi bi-geo-alt" style="color: blue;"></i>
                <span> ${local.direccion}</span>
              </p>
              <p class="mb-1">
                <img src="/static/assets/img/cancha.png" alt="Cancha" width="20" height="20">
                cuenta con ${local.cantidad_cancha} ${local.cantidad_cancha == 1 ? 'cancha' : 'canchas'}
              </p>
            </div>
          </div>
        </a>
      `;
      container.appendChild(col);
    });
  }

  function aplicarFiltros() {
    const nombreFiltro = document.getElementById('busquedaNombre').value.toLowerCase();
    const deportesSeleccionados = Array.from(document.querySelectorAll('#deportesFiltro input[name="deporte"]:checked')).map(cb => cb.value);
    const estado = document.getElementById('estadoAbierto').checked ? 'Abierto' : 'todos';

    const { hora, fecha } = obtenerHoraPeru();
    const [horaActual, minutoActual, segundoActual] = hora.split(':');
    const [dia, mes, anio] = fecha.split('/');
    const horaActualDate = new Date(anio, mes - 1, dia, horaActual, minutoActual, segundoActual);

    if (!localesData.length) {
      renderizarLocales([]);
      return;
    }

    const filtrarPorDeportes = !deportesSeleccionados.includes('deporteTodos');

    const filtrados = localesData.filter(local => {
      if (nombreFiltro && !local.nombre.toLowerCase().includes(nombreFiltro)) return false;

      if (filtrarPorDeportes) {
        const nombresSeleccionados = deportesData
          .filter(dep => deportesSeleccionados.includes(dep.idDeporte.toString()))
          .map(dep => dep.Deportes);
        if (!local.Deportes.some(dep => nombresSeleccionados.includes(dep))) return false;
      }

      if (estado === 'Abierto') {
        if (!local.horario || !local.horario.includes(':')) return false;
        const partes = local.horario.match(/(\d{2}:\d{2})/g);
        if (!partes || partes.length < 6) return false;

        const horarios = [
          { inicio: partes[0], fin: partes[1] },
          { inicio: partes[2], fin: partes[3] },
          { inicio: partes[4], fin: partes[5] }
        ];

        let abierto = false;
        for (let tramo of horarios) {
          const [hInicio, mInicio] = tramo.inicio.split(':');
          const [hFin, mFin] = tramo.fin.split(':');
          const horaInicioDate = new Date(anio, mes - 1, dia, hInicio, mInicio);
          let horaFinDate = new Date(anio, mes - 1, dia, hFin, mFin);
          if (horaFinDate <= horaInicioDate) horaFinDate.setDate(horaFinDate.getDate() + 1);
          if (horaActualDate >= horaInicioDate && horaActualDate <= horaFinDate) {
            abierto = true;
            break;
          }
        }
        if (!abierto) return false;
      }
      return true;
    });

    renderizarLocales(filtrados);
  }

  function cargarDatos() {
    fetch('/api_canchas')
      .then(res => res.json())
      .then(data => {
        localesData = data;
        renderizarLocales(data);
        aplicarFiltros();
      });

    fetch('/api_deportes')
      .then(res => res.json())
      .then(data => {
        deportesData = data;
        cargarDeportes(data);
      });
  }

  document.addEventListener('DOMContentLoaded', () => {
    cargarDatos();
    document.getElementById('busquedaNombre').addEventListener('input', aplicarFiltros);
    
    document.getElementById('estadoTodos').addEventListener('change', function () {
      if (!this.checked) {
        // Si se desmarca y "Abierto" tampoco está marcado, lo volvemos a marcar
        if (!document.getElementById('estadoAbierto').checked) {
          this.checked = true;
        }
      } else {
        document.getElementById('estadoAbierto').checked = false;
      }
      aplicarFiltros();
    });

    document.getElementById('estadoAbierto').addEventListener('change', function () {
      if (!this.checked) {
        // Si se desmarca y "Todos" tampoco está marcado, lo volvemos a marcar
        if (!document.getElementById('estadoTodos').checked) {
          this.checked = true;
        }
      } else {
        document.getElementById('estadoTodos').checked = false;
      }
      aplicarFiltros();
    });

    setInterval(() => {
      fetch('/api_canchas')
        .then(res => res.json())
        .then(data => {
          localesData = data;
          aplicarFiltros();
        });
    }, 10000);
  });
</script>



{% endblock %}
