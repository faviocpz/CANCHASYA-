{% extends 'base_interna.html' %}

{% block titulo_pagina %}
Agregar Cancha
{% endblock %}

{% block contenido %}
<div class="container mt-5">
  <form id="insertarCanchaForm" action="/insertar_cancha" method="POST" enctype="multipart/form-data" novalidate>
    <!-- Descripción -->
    <div class="card mb-3">
      <div class="card-header">Descripción de la cancha</div>
      <div class="card-body">
        <textarea class="form-control" id="descripcion_cancha" name="descripcion_cancha" rows="3" required></textarea>
      </div>
    </div>

    <!-- Tipo de cancha -->
    <div class="card mb-3">
      <div class="card-header">Tipo de cancha</div>
      <div class="card-body">
        <select class="form-select" id="tipo_cancha" name="tipo_cancha" required>
          <option value="" disabled selected>Seleccione el tipo de cancha</option>
          {% for tipo in canchas %}
          <option value="{{ tipo.idTipoCancha }}">{{ tipo.nombre }}</option>
          {% endfor %}
        </select>
      </div>
    </div>

    <!-- Precio por hora -->

    <div class="text-center">
      <div class="row">
        <div class="col">
          <div class="card mb-3">
            <div class="card-header">Precio por hora en la mañana</div>
            <div class="card-body">
              <input type="number" class="form-control" id="precio_cancha" name="precio_cancha_mañana" required>
            </div>
          </div>
        </div>
        <div class="col">
          <div class="card mb-3">
            <div class="card-header">Precio por hora en la tarde</div>
            <div class="card-body">
              <input type="number" class="form-control" id="precio_cancha" name="precio_cancha_tarde" required>
            </div>
          </div>
        </div>
        <div class="col">
          <div class="card mb-3">
            <div class="card-header">Precio por hora en la noche</div>
            <div class="card-body">
              <input type="number" class="form-control" id="precio_cancha" name="precio_cancha_noche" required>
            </div>
          </div>
        </div>
      </div>
    </div>







    <!-- Puntuación inicial -->
    <!-- <div class="card mb-3">
      <div class="card-header">Puntuación inicial</div>
      <div class="card-body">
        <input type="number"
               class="form-control"
               id="puntuacion_cancha"
               name="puntuacion_cancha"
               min="0" max="5" step="0.1"
               value="0.0"
               required>
      </div>
    </div> -->

    <!-- Horario disponible -->
    <!-- <div class="card mb-3">
      <div class="card-header">Horario disponible</div>
      <div class="card-body">
        <div class="row align-items-center">
          <div class="col-8">
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="checkbox" id="dia_todos" value="all">
              <label class="form-check-label" for="dia_todos">Todos</label>
            </div>
            <br>
            {% for dia in ['Lunes','Martes','Miércoles','Jueves','Viernes','Sábado','Domingo'] %}
              <div class="form-check form-check-inline">
                <input class="form-check-input dia-checkbox"
                       type="checkbox"
                       id="dia_{{ dia.lower() }}"
                       name="dias[]"
                       value="{{ dia }}">
                <label class="form-check-label" for="dia_{{ dia.lower() }}">{{ dia }}</label>
              </div>
            {% endfor %}
          </div>
          <div class="col-2">
            <label for="hora_inicio" class="form-label">Inicio</label>
            <input type="time" id="hora_inicio" name="hora_inicio" class="form-control" required>
          </div>
          <div class="col-2">
            <label for="hora_fin" class="form-label">Fin</label>
            <input type="time" id="hora_fin" name="hora_fin" class="form-control" required>
          </div>
        </div>
      </div>
    </div> -->

    <!-- Fotos de la cancha -->
    <div class="card mb-3">
      <div class="card-header">Fotos de la cancha</div>
      <div class="card-body">
        <div id="imagesContainer" class="d-flex align-items-start">
          <div class="image-upload me-3" id="imageUpload1">
            <input type="file" accept="image/*" id="foto_cancha_1" name="foto_cancha" onchange="previewImage(1)" hidden>
            <label for="foto_cancha_1" class="d-flex justify-content-center align-items-center border rounded"
              style="width:100px; height:100px; cursor:pointer;">
              <span class="text-muted">+</span>
            </label>
            <div id="foto_preview_1" class="mt-2"></div>
          </div>
        </div>
      </div>
    </div>

    <button type="submit" class="btn btn-primary">Agregar cancha</button>
  </form>
</div>

<!-- Modal de vista previa -->
<div class="modal fade" id="modalImage" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0">
      <div class="modal-body p-0">
        <img src="" id="modalImageSrc" class="img-fluid w-100" alt="Imagen cancha">
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  let imageCount = 1;

  function previewImage(index) {
    const input = document.getElementById(`foto_cancha_${index}`);
    if (input.files && input.files[0]) {
      const reader = new FileReader();
      reader.onload = e => {
        const wrapper = document.getElementById(`imageUpload${index}`);
        wrapper.querySelector('label').style.display = 'none';
        const previewDiv = document.getElementById(`foto_preview_${index}`);
        previewDiv.innerHTML = `
          <div class="position-relative d-inline-block">
            <img src="${e.target.result}"
                 class="img-thumbnail"
                 style="width:100px; height:100px; object-fit:cover;">
            <button type="button"
                    class="btn btn-light position-absolute top-0 end-0 p-1"
                    onclick="openImageModal('${e.target.result}')">
              <i class="bi bi-eye"></i>
            </button>
          </div>
        `;

        // al cargar imagen, auto-agregar siguiente input si cabe
        if (imageCount < 3 && !document.getElementById(`foto_cancha_${imageCount + 1}`)) {
          addMoreImages();
        }
      };
      reader.readAsDataURL(input.files[0]);
    }
  }

  function addMoreImages() {
    if (imageCount >= 3) return;
    imageCount++;
    const container = document.getElementById('imagesContainer');
    const uploadDiv = document.createElement('div');
    uploadDiv.className = 'image-upload me-3';
    uploadDiv.id = `imageUpload${imageCount}`;
    uploadDiv.innerHTML = `
      <input type="file" accept="image/*"
             id="foto_cancha_${imageCount}"
             name="foto_cancha"
             onchange="previewImage(${imageCount})"
             hidden>
      <label for="foto_cancha_${imageCount}"
             class="d-flex justify-content-center align-items-center border rounded"
             style="width:100px; height:100px; cursor:pointer;">
        <span class="text-muted">+</span>
      </label>
      <div id="foto_preview_${imageCount}" class="mt-2"></div>
    `;
    container.appendChild(uploadDiv);
  }

  function openImageModal(src) {
    document.getElementById('modalImageSrc').src = src;
    new bootstrap.Modal(document.getElementById('modalImage')).show();
  }

  // “Seleccionar todos” para los checkboxes de días
  document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('dia_todos').addEventListener('change', function () {
      document.querySelectorAll('.dia-checkbox')
        .forEach(ch => ch.checked = this.checked);
    });

    // Validación personalizada antes de submit
    document.getElementById('insertarCanchaForm')
      .addEventListener('submit', function (e) {
        const fileInputs = Array.from(
          document.querySelectorAll('input[type="file"][name="foto_cancha"]')
        );
        const anySelected = fileInputs.some(inp => inp.files.length > 0);
        if (!anySelected) {
          e.preventDefault();
          alert('Por favor selecciona al menos una imagen de la cancha.');
        }
      });
  });
</script>

{% endblock %}