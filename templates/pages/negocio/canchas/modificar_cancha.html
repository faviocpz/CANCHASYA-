{% extends 'base_interna.html' %}

{% block titulo_pagina %}
  Agregar Cancha
{% endblock %}

{% block contenido %}
<div class="container mt-5">
  <form id="insertarCanchaForm" action="/moficar_cancha/{{ id_cancha }}" method="POST" enctype="multipart/form-data" novalidate>
    <!-- Descripción -->
    <div class="card mb-3">
      <div class="card-header">Descripción de la cancha</div>
      <div class="card-body">
        <textarea class="form-control" id="descripcion_cancha" name="descripcion_cancha" rows="3" required >{{ datos.descripcion }}</textarea>
      </div>
    </div>

    <!-- Tipo de cancha -->
    <div class="card mb-3">
        <div class="card-header">Tipo de cancha</div>
        <div class="card-body">
          <select class="form-select" id="tipo_cancha" name="tipo_cancha" required>
            <option value="" disabled>Seleccione el tipo de cancha</option>
            {% for tipo in canchas %}
              <option value="{{ tipo.idTipoCancha }}" 
                      {% if tipo.idTipoCancha == datos.idDeporte %}selected{% endif %}>
                {{ tipo.nombre }}
              </option>
            {% endfor %}
          </select>
        </div>
      </div>
      
    <!-- Precio por hora -->
    <div class="card mb-3">
      <div class="card-header">Precio por hora en la mañana</div>
      <div class="card-body">
        <input type="number" class="form-control" id="precio_cancha" name="precio_cancha_mañana" required value="{{ datos.precio_manana }}">
      </div>
    </div>

    <div class="card mb-3">
      <div class="card-header">Precio por hora en la tarde</div>
      <div class="card-body">
        <input type="number" class="form-control" id="precio_cancha" name="precio_cancha_tarde" required value="{{ datos.precio_tarde }}">
      </div>
    </div>

    <div class="card mb-3">
      <div class="card-header">Precio por hora en la noche</div>
      <div class="card-body">
        <input type="number" class="form-control" id="precio_cancha" name="precio_cancha_noche" required value="{{ datos.precio_noche }}">
      </div>
    </div>

    
    <!-- Fotos de la cancha -->
<div class="card mb-3">
  <div class="card-header">Fotos de la cancha</div>
  <div class="card-body">
    <div id="imagesContainer" class="d-flex align-items-start flex-wrap gap-3">
      <!-- Fotos actuales -->
      {% for foto in fotos %}
      <div class="position-relative" style="width:100px;">
        <img src="{{ url_for('static', filename='assets/img/' + foto.foto) }}"
             class="img-thumbnail"
             style="width:100px; height:100px; object-fit:cover;">
        <button type="button"
                class="btn btn-danger btn-sm position-absolute top-0 end-0 p-1"
                onclick="eliminarFotoExistente(this, '{{ foto.id }}')">
          &times;
        </button>
        <!-- Cambié el nombre a fotos_nuevas[] para que todo vaya bajo el mismo campo -->
        <input type="hidden" name="fotos_nuevas[]" value="{{ foto.foto }}">
      </div>
      {% endfor %}

      <!-- Botón para añadir nueva imagen -->
      <div id="botonAgregarFoto" class="image-upload d-flex justify-content-center align-items-center border rounded"
           style="width:100px; height:100px; cursor:pointer;"
           onclick="crearInputImagen()">
        <span class="text-muted">+</span>
      </div>
    </div>
  </div>
</div>

<!-- Ya no es necesario este campo, ya que las fotos eliminadas se enviarán por medio de un botón -->
<input type="hidden" name="fotos_eliminadas" id="fotosEliminadas">

      

    <button type="submit" class="btn btn-primary">Modificar cancha</button>
  </form>
</div>

<!-- Modal de vista previa -->
<div class="modal fade" id="modalImage" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0">
      <div class="modal-body p-0">
        <img src="" id="modalImageSrc" class="img-fluid w-100" alt="Imagen cancha">
      </div>
    </div>
  </div>
</div>
{% endblock %} 

{% block scripts %}
<script>
  let nuevasFotos = 0;
  const maxFotos = 3;

  function contarFotosTotales() {
    const actuales = document.querySelectorAll('[name="fotos_nuevas[]"]').length;
    const nuevas = document.querySelectorAll('.foto-nueva').length;
    return actuales + nuevas;
  }

  function crearInputImagen() {
    if (contarFotosTotales() >= maxFotos) return;

    nuevasFotos++;
    const container = document.getElementById('imagesContainer');
    const botonAgregar = document.getElementById('botonAgregarFoto');

    const wrapper = document.createElement('div');
    wrapper.className = 'position-relative';
    wrapper.style.width = '100px';

    const inputId = `nuevaFoto_${nuevasFotos}`;

    wrapper.innerHTML = `
      <input type="file" accept="image/*" id="${inputId}" name="fotos_nuevas[]" class="foto-nueva d-none" onchange="mostrarPreview(this, ${nuevasFotos})">
      <label for="${inputId}" class="d-flex justify-content-center align-items-center border rounded"
            style="width:100px; height:100px; cursor:pointer;">
        <span class="text-muted">+</span>
      </label>
      <div id="preview_${nuevasFotos}" class="mt-1"></div>
    `;

    container.insertBefore(wrapper, botonAgregar);  // <== Esto es clave
    document.getElementById(inputId).click();
  }

  function mostrarPreview(input, index) {
    if (input.files && input.files[0]) {
      const reader = new FileReader();
      reader.onload = function (e) {
        const label = input.nextElementSibling;
        label.style.display = 'none';

        const previewDiv = document.getElementById(`preview_${index}`);
        previewDiv.innerHTML = `
          <div class="position-relative d-inline-block">
            <img src="${e.target.result}" class="img-thumbnail"
                style="width:100px; height:100px; object-fit:cover;">
            <button type="button"
                    class="btn btn-danger btn-sm position-absolute top-0 end-0 p-1"
                    onclick="eliminarNuevaFoto(this)">
              &times;
            </button>
          </div>
        `;

        // Verifica si se puede seguir agregando más fotos
        if (contarFotosTotales() >= maxFotos) {
          document.getElementById('botonAgregarFoto').style.display = 'none';
        }
      };
      reader.readAsDataURL(input.files[0]);
    }
  }

  function eliminarFotoExistente(btn, idFoto) {
    btn.closest('div').remove();
    const campo = document.getElementById('fotosEliminadas');
    campo.value += campo.value ? `,${idFoto}` : idFoto;

    if (contarFotosTotales() < maxFotos) {
      document.getElementById('botonAgregarFoto').style.display = 'flex';
    }
  }

  function eliminarNuevaFoto(btn) {
    const contenedor = btn.closest('.position-relative');
    contenedor.parentElement.parentElement.remove();

    if (contarFotosTotales() < maxFotos) {
      document.getElementById('botonAgregarFoto').style.display = 'flex';
    }
  }

  // Validar que haya al menos una imagen antes de enviar
  document.getElementById('insertarCanchaForm').addEventListener('submit', function (e) {
    const totalFotos = contarFotosTotales();
    if (totalFotos < 1) {
      e.preventDefault();
      alert('Debe haber al menos una imagen para guardar la cancha.');
    }
  });

</script>

{% endblock %}
