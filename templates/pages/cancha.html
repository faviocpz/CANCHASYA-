{% extends 'base.html' %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='assets/css/cancha.css') }}">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">

<div class="container">
  <!-- Cabecera mejorada -->
  <div class="header">
    <h1 class="fw-bold text-center">{{ local_info[0][0] }}</h1>

    <!-- Card con imagen y datos del local, ahora con clase 'header-card' -->
    <!-- Card con imagen y datos del local, ahora con clase 'header-card' -->
<div class="info-container shadow p-3 mb-4">
  
    <!-- Imagen Banner al costado izquierdo -->
    <div class="banner-box">
      <img src="{{ url_for('static', filename='assets/img/' + local_info[0][6]) }}" alt="Banner del Local" class="banner-img">
    </div>
    
    <!-- Información del local al costado derecho -->
    <div class="local-info ms-4">
      <p><strong>Dirección:</strong> {{ local_info[0][1] }}</p>
      <p><strong>Correo Electrónico:</strong> {{ local_info[0][2] }}</p>
      <p><strong>Teléfono:</strong> {{ local_info[0][3] }}</p>
      <!--<div class="social-links">
        <p><strong>Redes Sociales:</strong></p>
        <p><strong>Facebook:</strong> ElEsfericoFutbol</p>
        <p><strong>Instagram:</strong> @elesfericofutbol</p>
      </div>-->
       <div class="social-buttons">
        <a href="{% if local_info[0][4] %}
                    {{ 'https://www.facebook.com/' + local_info[0][4] if 'facebook.com' not in local_info[0][4] else local_info[0][4] }}
                  {% else %}
                    javascript:void(0);
                  {% endif %}" 
          class="facebook" target="_blank">
          <i class="bi bi-facebook"></i> Facebook
        </a>
                <a href="{% if local_info[0][5] %}
                    {{ 'https://www.instagram.com/' + local_info[0][5] if 'instagram.com' not in local_info[0][5] else local_info[0][5] }}
                  {% else %}
                    javascript:void(0);
                  {% endif %}" 
          class="instagram" target="_blank">
          <i class="bi bi-instagram"></i> Instagram
        </a>
      </div>

      <div class="turno-box">
        <h5>Turnos:</h5>
        {% for turno in turnos_info %}
        <p><strong>{{ turno[0] }}:</strong> {{ turno[1] }} - {{ turno[2] }}</p>
        {% endfor %}
      </div>
   
  </div>

</div>

  </div>
  <div class="text-center mb-4">
    <h2 class="text-primary fw-bold">Canchas Disponibles</h2>
  </div>


  <div class="row g-4 pb-5">
  {% for cancha in canchas_info %}
  <div class="col-12">
    <div class="card reserva-card flex-md-row shadow" data-id="{{ cancha[0] }}" data-descripcion="{{ cancha[1] }}">
      <!-- Carrusel de imágenes al lado izquierdo -->
      <div class="col-md-7 p-0">
        <div id="carouselCancha{{ cancha[0] }}" class="carousel slide h-100" data-bs-ride="carousel">
          <div class="carousel-inner h-100">
            {% for foto in canchas_fotos[cancha[0]] %}
            <div class="carousel-item {% if loop.first %} active {% endif %} h-100">
              <img src="{{ url_for('static', filename='assets/img/' ~ foto) }}" class="d-block w-100 h-100" alt="Imagen de la cancha">
            </div>
            {% endfor %}
          </div>
          <button class="carousel-control-prev" type="button" data-bs-target="#carouselCancha{{ cancha[0] }}" data-bs-slide="prev">
            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Anterior</span>
          </button>
          <button class="carousel-control-next" type="button" data-bs-target="#carouselCancha{{ cancha[0] }}" data-bs-slide="next">
            <span class="carousel-control-next-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Siguiente</span>
          </button>
        </div>
      </div>

      <!-- Información de la cancha al lado derecho -->
      <div class="col-md-5 p-4 d-flex flex-column">
        <!--<blockquote style="font-style: italic; color: #2c3e50; border-left: 4px solid #2980b9; padding-left: 10px;">
          {{ cancha[1] }}
        </blockquote>-->
        <h3><strong>{{ cancha[1] }}</strong></h3>

        <p><strong>Puntuación:</strong> 
          {% set rating = cancha[2] %}
          {% set full_stars = rating | int %}
          {% set half_star = (rating - full_stars) >= 0.5 %}
          {% for i in range(1, full_stars + 1) %}
            <i class="bi bi-star-fill text-warning"></i>
          {% endfor %}
          {% if half_star %}
            <i class="bi bi-star-half text-warning"></i>
          {% endif %}
          {% for i in range(full_stars + 1 + (1 if half_star else 0), 6) %}
            <i class="bi bi-star text-warning"></i>
          {% endfor %}
        </p>

        <p><strong>Precio por hora - Turno Mañana:</strong> S/. {{ cancha[3] }}</p>
        <p><strong>Precio por hora - Turno Tarde:</strong> S/. {{ cancha[4] }}</p>
        <p><strong>Precio por hora - Turno Noche:</strong> S/. {{ cancha[5] }}</p>

        <!--<div class="form-group">
          <label for="dateSelect">Selecciona una fecha:</label>
          <select class="form-control fechaReserva"></select>
        </div>-->

        <div class="mt-2">
          <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#scheduleModal">Horas Disponibles</button>
        </div>
      <!--
        <div class="form-group mt-3">
          <label for="startTime">Hora de inicio:</label>
          <input type="time" class="startTime form-control" data-id="{{ cancha[0] }}" disabled>
        </div>

        <div class="form-group mt-2">
          <label for="endTime">Hora de fin:</label>
          <input type="time" class="endTime form-control" data-id="{{ cancha[0] }}" disabled>
        </div>-->
        
        <p class="mt-3"><strong>Horas seleccionadas:</strong></p>
        <div class="horas-badges" id="horasSeleccionadas-{{ cancha[0] }}">
          
          <ul class="listaHorasSeleccionadas" data-id="{{ cancha[0] }}"></ul>
        </div>

         <!--
        <div class="caracteristicas mt-3">
          <button class="btn btn-info" onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none'">
            Cuenta con:
          </button>
          <ul style="display: none; margin-top: 5px;">
            {% for caracteristica in cancha_caracteristicas[cancha[0]] %}
              <li>{{ caracteristica }}</li>
            {% endfor %}
          </ul>
        </div>-->

        <div class="mt-auto pt-3 d-grid gap-2">
          <!--<a href="javascript:void(0);" id="whatsappBtn" class="btn btn-whatsapp">
            <i class="bi bi-whatsapp me-1"></i> Contactar por WhatsApp
          </a>-->
          <!--<a class="btn btn-whatsapp whatsappBtn" data-id="{{ cancha[0] }}"  href="#" target="_blank"
   rel="noopener">
  <i class="bi bi-whatsapp me-1"></i> Contactar por WhatsApp
</a>-->
<a class="btn btn-whatsapp whatsappBtn"
   data-id="{{ cancha[0] }}"
   href="javascript:void(0);"
   onclick="mostrarCargando(this)"
   target="_blank"
   rel="noopener noreferrer">
  <i class="bi bi-whatsapp me-1"></i> Contactar por WhatsApp
</a>



          <button class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#puntuacionModal3" data-id="{{ cancha[0] }}" data-bs-dismiss="modal">
            <i class="bi bi-star me-1"></i> Añadir Puntuación
          </button>
        </div>
      </div>
    </div>
  </div>
  {% endfor %}
</div>
 
<!-- Modal HTML -->
<!-- Modal HTML -->
<!-- Modal HTML -->
<div class="modal fade" id="puntuacionModal3" tabindex="-1" aria-labelledby="puntuacionModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="POST" action="{{ url_for('registrar_puntuacion') }}" id="puntuacionForm" class="formulario-puntuacion" >
        <div class="modal-header">
          <h5 class="modal-title" id="puntuacionModalLabel1">Puntuar Cancha</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <label for="puntuacion" class="form-label">Elige tu puntuación</label>
          <select class="form-select" name="puntuacion" id="puntuacion">
            <option value="1">⭐</option>
            <option value="2">⭐⭐</option>
            <option value="3">⭐⭐⭐</option>
            <option value="4">⭐⭐⭐⭐</option>
            <option value="5">⭐⭐⭐⭐⭐</option>
          </select>
        </div>
        <!-- Campo oculto para el idCancha -->
        <input type="hidden" name="idCancha" id="idCanchaInput"> <!-- Este es el campo que se actualiza dinámicamente -->
        <input type="hidden" name="idLocal" id="idLocalInput">
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Enviar</button>
        </div>
      </form>
    </div>
  </div>
</div>




<!-- Success message for confirmation -->
<div id="confirmationMessage" class="alert alert-success mt-3" style="display: none;">
  ¡Puntuación registrada correctamente!
</div>


<!-- Modal para mostrar los horarios -->
<div class="modal fade" id="scheduleModal" tabindex="-1" aria-labelledby="scheduleModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="scheduleModalLabel">Seleccionar Horario Disponible de Reserva</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        
        <!-- Horario de turno (Mañana, Tarde, Noche) -->
         <!-- Seleccionar la fecha -->
          
           <div class="form-group">
            <label for="fechaSelect">Selecciona la fecha:</label>
            <select class="form-control" id="modalFechaSelect"></select>
          </div> 
          <div id="cargandoHoras" style="display: none; font-weight: bold; text-align: center; padding: 10px;">⏳ Cargando horas disponibles...</div>
          <!--<p><strong>Horas Disponibles:</strong></p>-->
        <div id="turnosContainer" class="schedule mt-3">
          
          <!--{% for turno in turnos_info %}
          <div class="turno">
            <h6>{{ turno[0] }} ({{ turno[1] }} - {{ turno[2] }})</h6>
            <div class="hours">
              {% set start_hour = turno[1]|int %}
              {% set end_hour = turno[2]|int %}
              {% for hour in range(start_hour, end_hour) %}
                <button class="hour {% if hour in ocupadas %}ocupado{% else %}disponible{% endif %}" data-time="{{ hour }}">
                  {{ hour }}:00
                </button>
              {% endfor %}
            </div>
          </div>
           {% endfor %}-->
           
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        <button type="button" id="confirmarHorario" class="btn btn-primary" data-bs-dismiss="modal">Confirmar Horario</button>
      </div>
    </div>
  </div>
</div>

  </div>

  <div class="text-center my-4">
    <button class="btn btn-outline-primary mt-2" onclick="window.history.back();">← Regresar</button>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
<script>
   const numeroWhatsapp = "51{{ local_info[0][3] }}";  // Esto será reemplazado en el servidor por el número real

  const usuarioTelefono = "{{ session.get('telefono', '') }}";


document.addEventListener("DOMContentLoaded", function () {
    // 1. Llenar opciones de duración en todos los selects
    document.querySelectorAll('.duracionReserva').forEach(select => {
      for (let min = 20; min <= 120; min += 10) {
        const option = document.createElement("option");
        option.value = min;
        option.textContent = `${min} minutos`;
        select.appendChild(option);
      }
    });

    // 2. Escuchar cambios en cada tarjeta (card)
    document.querySelectorAll('.reserva-card').forEach(card => {
      const horaInicioInput = card.querySelector('.horaInicio');
      const duracionSelect = card.querySelector('.duracionReserva');
      const horaFinInput = card.querySelector('.horaFin');

      function calcularHoraFin() {
        const horaInicio = horaInicioInput.value;
        const duracion = parseInt(duracionSelect.value);

        // Validación: duración sin hora inicio
        if (!horaInicio && !isNaN(duracion)) {
          alert("Por favor selecciona la hora de inicio antes de elegir la duración.");
          horaFinInput.value = "";
          duracionSelect.value = "";
          return;
        }

        if (horaInicio && !isNaN(duracion)) {
          const [hora, minuto] = horaInicio.split(":").map(Number);
          const inicioDate = new Date();
          inicioDate.setHours(hora, minuto, 0);

          const finDate = new Date(inicioDate);
          finDate.setMinutes(finDate.getMinutes() + duracion);

          const horaCierre = new Date();
          horaCierre.setHours(23, 0, 0);

          if (finDate > horaCierre) {
            alert("La hora de fin no puede superar las 23:00.");
            horaFinInput.value = "";
            return;
          }

          const horaFin = finDate.toTimeString().slice(0, 5);
          horaFinInput.value = horaFin;
        } else {
          horaFinInput.value = "";
        }
      }

      // Escuchar eventos
      horaInicioInput.addEventListener('change', calcularHoraFin);
      duracionSelect.addEventListener('change', calcularHoraFin);
    });
  });
// Lógica para seleccionar horas
/*const hours = document.querySelectorAll('.hour.available');
hours.forEach(hour => {
  hour.addEventListener('click', function() {
    this.classList.toggle('selected'); // Cambia el estado al hacer clic
    if (this.classList.contains('selected')) {
      this.style.backgroundColor = '#17a2b8'; // Azul para mostrar la selección
    } else {
      this.style.backgroundColor = '#28a745'; // Verde cuando se deselecciona
    }
  });
});*/
// Función para manejar la selección del horario
document.addEventListener("DOMContentLoaded", function() {
  document.querySelectorAll(".hour").forEach(button => {
    button.addEventListener("click", function() {
      const selectedHour = this.getAttribute("data-time");
      // Aquí calculamos la hora de fin
      const endTime = calculateEndTime(selectedHour);
      document.getElementById("startTime").value = selectedHour + ":00";  // Hora de inicio
      document.getElementById("endTime").value = endTime;  // Hora de fin
    });
  });
});

// Función para calcular la hora de fin
function calculateEndTime(startTime) {
  const start = parseInt(startTime.split(":")[0]); // Convertir a entero
  const end = start + 1; // Por defecto, la duración es de 1 hora
  return `${end}:00`;
}
// MODAL HORARIO
function obtenerIdLocalDesdeURL() {
  const path = window.location.pathname; // e.g. /local/50
  const partes = path.split('/');
  const idLocal = partes[partes.length - 1]; // obtiene '50'
  return idLocal;
}
let horaSeleccionadaInicio = null;
let horaSeleccionadaFin = null;
let horasSeleccionadasGlobal = [];

document.getElementById("modalFechaSelect").addEventListener("change", function() {
  let fechaSeleccionada = this.value;
  let idLocal = obtenerIdLocalDesdeURL(); // Este valor debe ser dinámico según el local
 // Mostrar mensaje de carga
  const cargandoEl = document.getElementById("cargandoHoras");
  cargandoEl.style.display = "block";
  // Llamada al backend para obtener los horarios disponibles para esa fecha
  fetch(`/obtener_horas_disponibles?fecha=${fechaSeleccionada}&idLocal=${idLocal}&idCancha=${idCanchaSeleccionada}`)
    .then(response => response.json())
    .then(data => {
  const card = document.querySelector(`.reserva-card[data-id='${idCanchaSeleccionada}']`);
  const hIni = card?.getAttribute('data-hora-inicio');
  const hFin = card?.getAttribute('data-hora-fin');
  mostrarHoras(data.turnos, hIni, hFin);
  cargandoEl.style.display = "none";
});

});

// Función para mostrar las horas en el modal
function mostrarHoras(turnos, horaInicioGuardada = null, horaFinGuardada = null) {
  const container = document.getElementById("turnosContainer");
  container.innerHTML = '';

  turnos.forEach(turno => {
    const turnoElement = document.createElement('div');
    turnoElement.classList.add('turno');

    const titulo = document.createElement('h6');
    titulo.textContent = `${turno.nombre} (${turno.inicio} - ${turno.fin})`;
    turnoElement.appendChild(titulo);

    const hoursContainer = document.createElement('div');
    hoursContainer.classList.add('hours');

    turno.horas.forEach(hora => {
      
      const button = document.createElement('button');
      button.classList.add('hour');
      button.textContent = hora;
      button.setAttribute('data-time', hora);
      

      // 🔵 Preselección
      if (hora === horaInicioGuardada || hora === horaFinGuardada) {
        button.classList.add("seleccionado");
        button.style.backgroundColor = "#0d6efd";
        if (hora === horaInicioGuardada) horaSeleccionadaInicio = hora;
        if (hora === horaFinGuardada) horaSeleccionadaFin = hora;
      } else {
        button.style.backgroundColor = "#28a745";
      }

        button.addEventListener("click", function () {
  const botones = Array.from(document.querySelectorAll('#turnosContainer .hour'));

  // Toggle visual
  if (this.classList.contains("seleccionado")) {
    this.classList.remove("seleccionado");
    this.style.backgroundColor = "#28a745";
  } else {
    this.classList.add("seleccionado");
    this.style.backgroundColor = "#0d6efd";
  }

  // Recolectar todas las seleccionadas y ordenarlas
  const seleccionados = botones
    .filter(btn => btn.classList.contains("seleccionado"))
    .map(btn => btn.getAttribute("data-time"))
    .sort((a, b) => a.localeCompare(b));

  // Recolorear todos según selección
  botones.forEach(btn => {
    const hora = btn.getAttribute("data-time");
    if (seleccionados.includes(hora)) {
      btn.classList.add("seleccionado");
      btn.style.backgroundColor = "#0d6efd";
    } else {
      btn.classList.remove("seleccionado");
      btn.style.backgroundColor = "#28a745";
    }
  });

  // Actualizar variables globales
  if (seleccionados.length >= 2) {
    horaSeleccionadaInicio = seleccionados[0];
    horaSeleccionadaFin = seleccionados[seleccionados.length - 1];
  } else if (seleccionados.length === 1) {
    horaSeleccionadaInicio = seleccionados[0];
    horaSeleccionadaFin = null;
  } else {
    horaSeleccionadaInicio = null;
    horaSeleccionadaFin = null;
  }
});





      hoursContainer.appendChild(button);
    });

    turnoElement.appendChild(hoursContainer);
    container.appendChild(turnoElement);
  });
}

// Función para confirmar la hora seleccionada
/*document.getElementById("confirmarHorario").addEventListener("click", function() {
  if (horaSeleccionadaInicio && horaSeleccionadaFin) {
    // Si se han seleccionado ambas horas, actualizamos los campos
    document.getElementById("startTime").value = horaSeleccionadaInicio + ":00";
    document.getElementById("endTime").value = horaSeleccionadaFin + ":00";
   
  } else {
    alert("Por favor, selecciona un rango de hora válido.");
  }
});*/
document.addEventListener("DOMContentLoaded", function() {
  // Establecer la fecha mínima para el selector de fecha
  const fechaSelect = document.getElementById("fechaSelect");
  const today = new Date();
  
  // Formatear la fecha en formato YYYY-MM-DD
  const formattedDate = today.toISOString().split('T')[0];
  
  // Establecer el atributo min del input para que no se puedan seleccionar fechas pasadas
  fechaSelect.setAttribute("min", formattedDate);
});

// MENSAJE WSP
// Seleccionar los elementos de fecha y hora
/*const fechaSelect = document.getElementById("modalFechaSelect");
 if (fechaSelect.options.length > 1) {
    // Si la opción actual no es la de "Selecciona una fecha"
    const primeraFechaValida = fechaSelect.options[1].value;
    fechaSelect.selectedIndex = 1;

    // Ejecuta manualmente el change
    fechaSelect.dispatchEvent(new Event('change'));
  }*/
const startTime = document.getElementById("startTime");
const endTime = document.getElementById("endTime");

// Botón de WhatsApp
//const whatsappButton = document.getElementById("whatsappBtn");
// Este botón será el que corresponde a la cancha que esté visible o activa idCanchaSeleccionada 
let whatsappButton = null;
let idCanchaSeleccionada = null;

/*document.querySelectorAll('[data-bs-target="#scheduleModal"]').forEach(button => {
  button.addEventListener("click", function () {
    idCanchaSeleccionada = this.closest('.reserva-card').getAttribute('data-id');
    document.getElementById("idCanchaInput").value = idCanchaSeleccionada;
  });
});*/
document.querySelectorAll('[data-bs-target="#scheduleModal"]').forEach(button => {
  button.addEventListener("click", function () {
    const card = this.closest(".reserva-card");
    //const id = this.closest(".reserva-card").querySelector(".startTime").getAttribute("data-id");
    const id = this.closest(".reserva-card").getAttribute("data-id");

      idCanchaSeleccionada = id; 
    document.getElementById("idCanchaInput").value = id;
       // 🟡 NUEVO: Limpiar selección previa del modal
    horaSeleccionadaInicio = null;
    horaSeleccionadaFin = null;
    document.getElementById("turnosContainer").innerHTML = "";
    // Limpiar la lista de horas seleccionadas del frontend
    const listaHoras = document.querySelector(`.listaHorasSeleccionadas[data-id='${id}']`);
    if (listaHoras) {
      listaHoras.innerHTML = '';
    }
    const btnWhatsApp = document.querySelector(`.whatsappBtn[data-id='${id}']`);
    if (btnWhatsApp) {
      btnWhatsApp.setAttribute("href", "javascript:void(0);");
    }


    const fechaSelect = document.getElementById("modalFechaSelect");
    if (fechaSelect) {
      // Si el card tiene datos previos, los usamos
      if (card.hasAttribute('data-fecha')) {
        const fechaGuardada = card.getAttribute('data-fecha');
        const horaInicioGuardada = card.getAttribute('data-hora-inicio');
        const horaFinGuardada = card.getAttribute('data-hora-fin');

        // Seleccionamos la fecha en el select
        for (let i = 0; i < fechaSelect.options.length; i++) {
          if (fechaSelect.options[i].value === fechaGuardada) {
            fechaSelect.selectedIndex = i;
            break;
          }
        }

        // Asignamos las horas guardadas para que se muestren al cargar
        horaSeleccionadaInicio = horaInicioGuardada;
        horaSeleccionadaFin = horaFinGuardada;

        // Ejecutamos el cambio para que se carguen las horas
        fechaSelect.dispatchEvent(new Event('change'));
      } else {
        // Si no hay datos guardados, reinicia
        fechaSelect.selectedIndex = 0;
      }
    }
// Limpiar visualmente los botones seleccionados (si ya estaban pintados)
    /*const horas = document.querySelectorAll("#turnosContainer .hour.seleccionado");
    horas.forEach(h => {
      h.classList.remove("seleccionado");
      h.style.backgroundColor = "#28a745";
    });

    // 🟡 NUEVO: Reiniciar el select de fecha
    const fechaSelect = document.getElementById("modalFechaSelect");
    if (fechaSelect) {
      fechaSelect.selectedIndex = 0; // vuelve a "Selecciona una fecha"
      document.getElementById("turnosContainer").innerHTML = ""; // limpia horas del modal
    }*/
  });
});

/*document.getElementById("confirmarHorario").addEventListener("click", function () {
  if (horaSeleccionadaInicio && horaSeleccionadaFin) {
    // Obtener los inputs específicos por ID de cancha
    const startInput = document.querySelector(`.startTime[data-id='${idCanchaSeleccionada}']`);
    const endInput = document.querySelector(`.endTime[data-id='${idCanchaSeleccionada}']`);
    const whatsappButton = document.querySelector(`.whatsappBtn[data-id='${idCanchaSeleccionada}']`);

    startInput.value = horaSeleccionadaInicio + ":00";
    endInput.value = horaSeleccionadaFin + ":00";

    // Habilitar el botón y poner el link
    const fecha = document.getElementById("modalFechaSelect").value;
    if (fecha) {
      const mensaje = `Hola, quiero reservar la cancha del local para el día ${fecha}. Hora de inicio: ${horaSeleccionadaInicio}. Hora de fin: ${horaSeleccionadaFin}.`;
      const link = `https://wa.me/{{ local_info[0][7] }}?text=${encodeURIComponent(mensaje)}`;
      whatsappButton.removeAttribute('disabled');
      whatsappButton.setAttribute('href', link);
    }
  } else {
    alert("Por favor, selecciona un rango de hora válido.");
  }
});/*


/**/
function mostrarCargando(btn) {
    event.preventDefault(); // ⛔
  const idCancha = btn.getAttribute("data-id");
  // Validación de sesión

  const link = document.querySelector(`.whatsappBtn[data-id='${idCancha}']`).getAttribute("href");
  if (!link || link === "javascript:void(0);") {
    alert("Por favor, selecciona una fecha y al menos una hora.");
    return; // 🚫 detiene redirección
  }
  if (!usuarioTelefono) {
    alert("Por favor, inicia sesión para poder contactar con el local por WhatsApp.");
    return; // 🚫 NO continuar
    }

  btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Abriendo...';
  setTimeout(() => {
    window.open(link, "_blank");
    btn.innerHTML = '<i class="bi bi-whatsapp me-1"></i> Contactar por WhatsApp';
  }, 500);
}



//calcula el enlace de WhatsApp cuando se seleccione la fecha y las horas
document.getElementById("confirmarHorario").addEventListener("click", function () {
  const fechaSeleccionada = document.getElementById("modalFechaSelect").value;
  const idCancha = document.getElementById("idCanchaInput").value;

  //const inputHoraInicio = document.querySelector(`.startTime[data-id='${idCancha}']`);
  //const inputHoraFin = document.querySelector(`.endTime[data-id='${idCancha}']`);
  const btnWhatsApp = document.querySelector(`.whatsappBtn[data-id='${idCancha}']`);
  const card = document.querySelector(`.reserva-card[data-id='${idCancha}']`);
  const descripcionCancha = card.getAttribute("data-descripcion");



  if (horaSeleccionadaInicio && fechaSeleccionada) {
    //inputHoraInicio.value = horaSeleccionadaInicio + ":00";
    //inputHoraFin.value = horaSeleccionadaFin + ":00";
    horasSeleccionadasGlobal = [];
        const botonesSeleccionados = document.querySelectorAll("#turnosContainer .hour.seleccionado");
        botonesSeleccionados.forEach(btn => {
          horasSeleccionadasGlobal.push(btn.getAttribute("data-time"));
        });

        // Ordenamos las horas
        horasSeleccionadasGlobal.sort((a, b) => a.localeCompare(b));

        // Construimos intervalos
        const lista = document.querySelector(`.listaHorasSeleccionadas[data-id='${idCancha}']`);
        lista.innerHTML = ''; // limpiar anteriores

        horasSeleccionadasGlobal.forEach(hora => {
          const horaInt = parseInt(hora.split(":")[0]);
          const siguiente = (horaInt + 1).toString().padStart(2, "0") + ":00";
          const li = document.createElement("li");
li.classList.add("hora-seleccionada-item");

const texto = document.createElement("span");
texto.textContent = `${hora} - ${siguiente}`;

const eliminarBtn = document.createElement("button");
eliminarBtn.innerHTML = "❌";
eliminarBtn.classList.add("btn-eliminar-hora");
eliminarBtn.style.marginLeft = "8px";
eliminarBtn.onclick = function () {
  // Remover hora del arreglo
  const index = horasSeleccionadasGlobal.indexOf(hora);
  if (index > -1) {
    horasSeleccionadasGlobal.splice(index, 1);
    actualizarHorasSeleccionadas(idCancha); // volver a renderizar la lista
  }
};

li.appendChild(texto);
li.appendChild(eliminarBtn);
lista.appendChild(li);

        });


  // ✅ Guardar selección en atributos del card
   // card.setAttribute('data-fecha', fechaSeleccionada);
    //card.setAttribute('data-hora-inicio', horaSeleccionadaInicio);
    //card.setAttribute('data-hora-fin', horaSeleccionadaFin);
    // Extraer todas las horas seleccionadas y ordenarlas
const horasSeleccionadas1 = Array.from(document.querySelectorAll('#turnosContainer .hour.seleccionado'))
    .map(btn => btn.getAttribute('data-time'))
    .sort((a, b) => a.localeCompare(b));

// Generar bloques horarios tipo 07:00-08:00, 08:00-09:00
let bloques = [];
for (let i = 0; i < horasSeleccionadas1.length; i++) {
    const inicio = horasSeleccionadas1[i];
    const siguiente = horasSeleccionadas1[i + 1];

    // Solo agregamos bloques consecutivos (por ejemplo, de 07:00 a 08:00)
    if (siguiente) {
        const [h1, m1] = inicio.split(":").map(Number);
        const [h2, m2] = siguiente.split(":").map(Number);
        if (h2 === h1 + 1) {
            bloques.push(`${inicio}-${siguiente}`);
        }
    }
}

// Si no hay bloques, usamos solo las horas individuales
if (bloques.length === 0 && horasSeleccionadas1.length === 1) {
    bloques.push(`${horasSeleccionadas1[0]}-${parseInt(horasSeleccionadas1[0].split(":")[0]) + 1}:00`);
}

const formatearAMPM = (horaStr) => {
  const [hora, minutos] = horaStr.split(":").map(Number);
  const ampm = hora >= 12 ? "PM" : "AM";
  const hora12 = ((hora % 12) || 12).toString().padStart(2, "0");
  return `${hora12}:${minutos.toString().padStart(2, "0")} ${ampm}`;
};

const bloquesTexto = horasSeleccionadasGlobal
  .map(hora => {
    const horaInt = parseInt(hora.split(":")[0]);
    const siguiente = (horaInt + 1).toString().padStart(2, "0") + ":00";
    return `${formatearAMPM(hora)} - ${formatearAMPM(siguiente)}`;
  }).join(", ");

// Mensaje de WhatsApp con todas las horas detalladas
const mensaje = `Hola, deseo reservar la cancha "${descripcionCancha}" para el día ${fechaSeleccionada} en los siguientes horarios: ${bloquesTexto}`;

     
    //const mensaje = `Hola, quiero reservar la cancha del local para el día ${fechaSeleccionada}. Hora de inicio: ${horaSeleccionadaInicio}. Hora de fin: ${horaSeleccionadaFin}.`;
    const mensajeCodificado = encodeURIComponent(mensaje);
    const link = `https://wa.me/${numeroWhatsapp}?text=${mensajeCodificado}`;
    btnWhatsApp.removeAttribute('disabled');
    console.log("✅ LINK generado:", link);

    btnWhatsApp.setAttribute("href", link);
   
    const modal = bootstrap.Modal.getInstance(document.getElementById('scheduleModal'));
    //modal.hide();
    //btnWhatsApp.setAttribute("href", `https://wa.me/{{ local_info[0][7] }}?text=${mensajeCodificado}`);
  } else {
    alert("Por favor, selecciona una fecha y almenos una hora.");
  }
});

function actualizarHorasSeleccionadas(idCancha) {
  const lista = document.querySelector(`.listaHorasSeleccionadas[data-id='${idCancha}']`);
  const fechaSeleccionada = document.getElementById("modalFechaSelect").value;
  const card = document.querySelector(`.reserva-card[data-id='${idCancha}']`);
  const descripcionCancha = card.getAttribute("data-descripcion");
  const btnWhatsApp = document.querySelector(`.whatsappBtn[data-id='${idCancha}']`);
  
  lista.innerHTML = '';

  if (horasSeleccionadasGlobal.length === 0) {
    btnWhatsApp.setAttribute("href", "javascript:void(0);");
    return;
  }

  const bloquesTexto = [];

  horasSeleccionadasGlobal.forEach(hora => {
    const horaInt = parseInt(hora.split(":")[0]);
    const siguiente = (horaInt + 1).toString().padStart(2, "0") + ":00";
    const bloque = `${hora} - ${siguiente}`;
    bloquesTexto.push(bloque);

    const li = document.createElement("li");
    li.classList.add("hora-seleccionada-item");

    const texto = document.createElement("span");
    texto.textContent = bloque;

    const eliminarBtn = document.createElement("button");
    eliminarBtn.innerHTML = "❌";
    eliminarBtn.classList.add("btn-eliminar-hora");
    eliminarBtn.style.marginLeft = "8px";

    eliminarBtn.onclick = function () {
      const index = horasSeleccionadasGlobal.indexOf(hora);
      if (index > -1) {
        horasSeleccionadasGlobal.splice(index, 1);
        actualizarHorasSeleccionadas(idCancha); // Recursivo para actualizar interfaz y href
      }
    };

    li.appendChild(texto);
    li.appendChild(eliminarBtn);
    lista.appendChild(li);
  });

  if (fechaSeleccionada && bloquesTexto.length > 0) {
    const mensaje = `Hola, deseo reservar la cancha "${descripcionCancha}" para el día ${fechaSeleccionada} en los siguientes horarios: ${bloquesTexto.join(', ')}`;
    const mensajeCodificado = encodeURIComponent(mensaje);
    const link = `https://wa.me/${numeroWhatsapp}?text=${mensajeCodificado}`;
    btnWhatsApp.setAttribute("href", link);
  } else {
    btnWhatsApp.setAttribute("href", "javascript:void(0);");
  }
}



/*document.querySelectorAll(".formulario-puntuacion").forEach(formulario => {
  formulario.addEventListener("submit", function (e) {
    // ... aquí puedes insertar la línea
    localStorage.setItem("puntuacionExitosa", "true");
  });
});*/
document.querySelectorAll(".formulario-puntuacion").forEach(formulario => {
  formulario.addEventListener("submit", function () {
    localStorage.setItem("puntuacionExitosa", "true");
  });
});
/*
document.addEventListener("DOMContentLoaded", function () {
  if (localStorage.getItem("puntuacionExitosa") === "true") {
    alert("¡Puntuación registrada exitosamente!");
    localStorage.removeItem("puntuacionExitosa");
  }
});*/
document.addEventListener("DOMContentLoaded", function () {
  if (localStorage.getItem("puntuacionExitosa") === "true") {
    Toastify({
      text: "¡Puntuación registrada exitosamente!",
      duration: 3000,
      close: true,
      gravity: "top",
      position: "right",
      backgroundColor: "#4CAF50",
    }).showToast();

    localStorage.removeItem("puntuacionExitosa");
  }
});



// Validar que solo se pueda hacer clic si se ha confirmado antes
document.querySelectorAll(".whatsappBtn").forEach(btn => {
  btn.addEventListener("click", function (event) {
    const fechaSeleccionada = document.getElementById("modalFechaSelect").value;
  const idCancha = document.getElementById("idCanchaInput").value;

  const inputHoraInicio = document.querySelector(`.startTime[data-id='${idCancha}']`);
  const inputHoraFin = document.querySelector(`.endTime[data-id='${idCancha}']`);
  const btnWhatsApp = document.querySelector(`.whatsappBtn[data-id='${idCancha}']`);
  const card = document.querySelector(`.reserva-card[data-id='${idCancha}']`);

    if (!horaSeleccionadaInicio || !fechaSeleccionada) {
      event.preventDefault(); // ❌ evita que abra WhatsApp
      //alert("Por favor, selecciona una fecha  y al menos una hora.");
    }
    if (!usuarioTelefono) {
     event.preventDefault(); // ❌ evita que abra WhatsApp
    }
  });
});

//confirmacion puntuacion
// Este JavaScript asegura que el modal reciba el idCancha correcto
document.querySelectorAll('[data-bs-target="#puntuacionModal3"]').forEach(button => {
  button.addEventListener('click', function() {
    var idCancha = this.getAttribute('data-id'); // Capturamos el idCancha
    document.getElementById('idCanchaInput').value = idCancha; // Asignamos el idCancha al input oculto
    let idLocal1 = obtenerIdLocalDesdeURL();
    document.getElementById('idLocalInput').value = idLocal1;
  });
});







//------------------
//seleccionar fecha
document.addEventListener("DOMContentLoaded", function () {
generarFechasParaSelect(document.getElementById("modalFechaSelect"));
  // Inicialización de fechas en cada .fechaReserva
  document.querySelectorAll('.fechaReserva').forEach(select => {
    generarFechasParaSelect(select); // Genera fechas en cada tarjeta
  });

  // Actualiza cada 60 segundos por si cambia el día
  setInterval(() => {
    const ahora = new Date();
    ahora.setHours(0, 0, 0, 0);

    if (ahora.getTime() !== fechaBase.getTime()) {
      fechaBase = ahora;
      document.querySelectorAll('.fechaReserva').forEach(select => {
        generarFechasParaSelect(select);
      });
    }
  }, 60000);
});

// Función global
let fechaBase = new Date();
fechaBase.setHours(0, 0, 0, 0);

// Función que llena fechas en un <select>
function generarFechasParaSelect(select) {
  select.innerHTML = '';
  // Agrega una opción inicial por defecto
  const opcionInicial = document.createElement('option');
  opcionInicial.value = '';
  opcionInicial.textContent = 'Selecciona una fecha';
  opcionInicial.disabled = true;
  opcionInicial.selected = true;
  select.appendChild(opcionInicial);
  for (let i = 0; i <= 4; i++) {
    const fecha = new Date();
    fecha.setDate(fecha.getDate() + i);

    const yyyy = fecha.getFullYear();
    const mm = String(fecha.getMonth() + 1).padStart(2, '0');
    const dd = String(fecha.getDate()).padStart(2, '0');
    const valor = `${yyyy}-${mm}-${dd}`;
    const visible = `${dd}/${mm}/${yyyy}`;

    const opcion = document.createElement('option');
    opcion.value = valor;
    opcion.textContent = visible;
    select.appendChild(opcion);
  }
}


</script>
<script>
  // Suponiendo que cancha_caracteristicas es un diccionario de características por cancha
  
  
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap" rel="stylesheet">
{% endblock %}

{% block scripts%}
<script src="/static/assets/js/login.js"></script>
{% endblock%}
