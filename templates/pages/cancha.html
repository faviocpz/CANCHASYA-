{% extends 'base.html' %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='assets/css/cancha.css') }}">

<div class="container">
  <!-- Cabecera mejorada -->
  <div class="header">
    <h1 class="fw-bold text-center">{{ local_info[0][0] }}</h1>

    <!-- Card con imagen y datos del local, ahora con clase 'header-card' -->
    <!-- Card con imagen y datos del local, ahora con clase 'header-card' -->
<div class="info-container shadow p-3 mb-4">
  
    <!-- Imagen Banner al costado izquierdo -->
    <div class="banner-box">
      <img src="{{ url_for('static', filename='assets/img/' + local_info[0][6]) }}" alt="Banner del Local" class="banner-img">
    </div>
    
    <!-- Información del local al costado derecho -->
    <div class="local-info ms-4">
      <p><strong>Dirección:</strong> {{ local_info[0][1] }}</p>
      <p><strong>Correo Electrónico:</strong> {{ local_info[0][2] }}</p>
      <p><strong>Teléfono:</strong> {{ local_info[0][3] }}</p>
      <!--<div class="social-links">
        <p><strong>Redes Sociales:</strong></p>
        <p><strong>Facebook:</strong> ElEsfericoFutbol</p>
        <p><strong>Instagram:</strong> @elesfericofutbol</p>
      </div>-->
      <div class="social-buttons">
        <a href="https://www.facebook.com/{{ local_info[0][4] }}" class="facebook" target="_blank">
          <i class="bi bi-facebook"></i> Facebook
        </a>
        <a href="https://www.instagram.com{{ local_info[0][5] }}" class="instagram" target="_blank">
          <i class="bi bi-instagram"></i> Instagram
        </a>
      </div>
      <div class="turno-box">
        <h5>Turnos:</h5>
        {% for turno in turnos_info %}
        <p><strong>{{ turno[0] }}:</strong> {{ turno[1] }} - {{ turno[2] }}</p>
        {% endfor %}
      </div>
   
  </div>

</div>

  </div>
  <div class="text-center mb-4">
    <h2 class="text-primary fw-bold">Canchas Disponibles</h2>
  </div>


  <div class="row g-4 pb-5">
    {% for cancha in canchas_info %}
    <div class="col-sm-12 col-md-4">
      <div class="card reserva-card">
        <div id="carouselCancha{{ cancha[0] }}" class="carousel slide" data-bs-ride="carousel">
          <div class="carousel-inner">
            {% for foto in canchas_fotos[cancha[0]] %}
            <!-- Imagen 1 -->
            <div class="carousel-item {% if loop.first %} active {% endif %}">
              <img src="{{ url_for('static', filename='assets/img/' ~ foto) }}" class="d-block w-100" alt="Imagen de la cancha 1">
            </div>
            <!-- Imagen 2 -->
            {% endfor %}
          </div>
          <button class="carousel-control-prev" type="button" data-bs-target="#carouselCancha{{ cancha[0] }}" data-bs-slide="prev">
            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Previous</span>
          </button>
          <button class="carousel-control-next" type="button" data-bs-target="#carouselCancha{{ cancha[0] }}" data-bs-slide="next">
            <span class="carousel-control-next-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Next</span>
          </button>
        </div>
        <div class="card-body d-flex flex-column">
          <!--<h5 class="card-title">{{ cancha[1] }}</h5>-->
          <blockquote style="font-style: italic; color: #2c3e50; border-left: 4px solid #2980b9; padding-left: 10px;">
            {{ cancha[1] }} </blockquote>
            <p><strong>{{ cancha[1] }}</strong></p>
       <!--<p style="background-color: #e0f7fa; padding: 0.5rem; border-radius: 8px;">
        Cancha con buena iluminación nocturna. Excelente para partidos en la noche o en días lluviosos, con tribunas para espectadores.
     </p>-->
            

     <p><strong>Puntuación:</strong> 
      {% set rating = cancha[2] %} <!-- Suponemos que la puntuación está en el tercer valor -->
      
      {% set full_stars = rating | int %}
      {% set half_star = (rating - full_stars) >= 0.5 %}
      
      <!-- Mostrar estrellas completas -->
      {% for i in range(1, full_stars + 1) %}
        <i class="bi bi-star-fill text-warning"></i>
      {% endfor %}
      
      <!-- Mostrar una estrella media si es necesario -->
      {% if half_star %}
        <i class="bi bi-star-half text-warning"></i>
      {% endif %}
      
      <!-- Completar las estrellas vacías hasta 5 -->
      {% for i in range(full_stars + 1 + (1 if half_star else 0), 6) %}
        <i class="bi bi-star text-warning"></i>
      {% endfor %}
    </p>
    
  
          <p><strong>Precio por hora:</strong> S/. {{ cancha[3] }}</p>
          <div class="form-group">
            <label for="dateSelect">Selecciona una fecha:</label>
            <select class="form-control fechaReserva">

              <!-- Las opciones se llenarán dinámicamente desde JavaScript -->
            </select>
          </div>
             <!--<p><strong>Horario de atención:</strong> 10:00 AM - 22:00 PM</p>-->
             <div class="mt-4">
              <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#scheduleModal">Seleccionar Horario</button>
            </div>
            <div class="form-group mt-3">
              <label>Hora de inicio:</label>
              <input type="time" class="form-control horaInicio">
            </div>
            
            <!--<div class="form-group mt-2">
              <label>Duración (minutos):</label>
              <select id="durationSelect" class="form-control">
                <option value="15">15 minutos</option>
                <option value="30">30 minutos</option>
                <option value="60">1 hora</option>
                <option value="90">1 hora 30 minutos</option>
                <option value="120">2 horas</option>
              </select>
            </div>-->
            <!--<div class="form-group mt-2">
              <label>Duración de la reserva:</label>
              <select class="form-control" id="duracionReserva">
                <option value="">-- Seleccione duración --</option>
              </select>
            </div>-->
            <div class="form-group mt-2">
              <label>Duración de la reserva:</label>
              <select class="form-control duracionReserva">
                <option value="">-- Selecciona duración --</option>
              </select>
            </div>
            
            <div class="form-group mt-2">
              <label>Hora de fin:</label>
              <input type="time" class="form-control horaFin" readonly>

            </div>

            <!--<<div class="caracteristicas">
              <p><strong>Cuenta con:</strong></p>
              <ul>
                {% for caracteristica in cancha_caracteristicas[cancha[0]] %}
                  <li>{{ caracteristica }}</li>
                {% endfor %}
              </ul>
            </div>-->
            <div class="caracteristicas">
              <!--<p><strong>Cuenta con:</strong></p>-->

              <!-- Botón para mostrar/ocultar la lista -->
              <button class="btn btn-info" onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none'">
                Cuenta con:
              </button>
          
              <!-- Lista desplegable con las características -->
              <!-- Lista desplegable con las características específicas de la cancha -->
              <ul style="display: none; margin-top: 5px;">
                {% for caracteristica in cancha_caracteristicas[cancha[0]] %}
                    <li>{{ caracteristica }}</li>
                {% endfor %}
              </ul>

          </div>
                
            
          <div class="mt-auto pt-3 d-grid gap-2">
            <a href="https://wa.me/{{ local_info[0][7] }}?text=Hola, quiero reservar la cancha {{ cancha[1] }} del local {{ local_info[0][0] }} para el día {{ fechaSeleccionada }}. Hora de inicio: {{ horaInicio }}. Hora de fin: {{ horaFin }}."
            class="btn btn-whatsapp">
             <i class="bi bi-whatsapp me-1"></i> Contactar por WhatsApp
           </a>
        
           <button class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#puntuacionModal3">
             <i class="bi bi-star me-1"></i> Añadir Puntuación
           </button>     
         </div>

  
        </div>
      </div>
    </div>
    {% endfor %}
  </div>   
<div class="modal fade" id="puntuacionModal3" tabindex="-1" aria-labelledby="puntuacionModalLabel" aria-hidden="true">
 <div class="modal-dialog">
   <div class="modal-content">
     <form method="POST" > 
       <div class="modal-header">
         <h5 class="modal-title" id="puntuacionModalLabel1">Puntuar Cancha</h5>
         <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
       </div>
       <div class="modal-body">
         <label for="puntuacion" class="form-label">Elige tu puntuación</label>
         <select class="form-select" name="puntuacion" id="puntuacion">
           <option value="1">⭐</option>
           <option value="2">⭐⭐</option>
           <option value="3">⭐⭐⭐</option>
           <option value="4">⭐⭐⭐⭐</option>
           <option value="5">⭐⭐⭐⭐⭐</option>
         </select>
       </div>
       <div class="modal-footer">
         <button type="submit" class="btn btn-primary">Enviar</button>
       </div>
     </form>
   </div>
 </div>
</div>
<!-- Modal para mostrar los horarios -->
<div class="modal fade" id="scheduleModal" tabindex="-1" aria-labelledby="scheduleModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="scheduleModalLabel">Seleccionar Horario de Reserva</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        
        <!-- Horario de turno (Mañana, Tarde, Noche) -->
         <!-- Seleccionar la fecha -->
          <div class="form-group">
            <label for="fechaSelect">Selecciona la fecha:</label>
            <input type="date" id="fechaSelect" class="form-control">
          </div>
        <div id="turnosContainer" class="schedule">
          <!--{% for turno in turnos_info %}
          <div class="turno">
            <h6>{{ turno[0] }} ({{ turno[1] }} - {{ turno[2] }})</h6>
            <div class="hours">
              {% set start_hour = turno[1]|int %}
              {% set end_hour = turno[2]|int %}
              {% for hour in range(start_hour, end_hour) %}
                <button class="hour {% if hour in ocupadas %}ocupado{% else %}disponible{% endif %}" data-time="{{ hour }}">
                  {{ hour }}:00
                </button>
              {% endfor %}
            </div>
          </div>
           {% endfor %}-->
           
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        <button type="button" class="btn btn-primary">Confirmar Horario</button>
      </div>
    </div>
  </div>
</div>

  </div>

  <div class="text-center my-4">
    <button class="btn btn-outline-primary mt-2" onclick="window.history.back();">← Regresar</button>
  </div>
</div>
<script>
document.addEventListener("DOMContentLoaded", function () {
    // 1. Llenar opciones de duración en todos los selects
    document.querySelectorAll('.duracionReserva').forEach(select => {
      for (let min = 20; min <= 120; min += 10) {
        const option = document.createElement("option");
        option.value = min;
        option.textContent = `${min} minutos`;
        select.appendChild(option);
      }
    });

    // 2. Escuchar cambios en cada tarjeta (card)
    document.querySelectorAll('.reserva-card').forEach(card => {
      const horaInicioInput = card.querySelector('.horaInicio');
      const duracionSelect = card.querySelector('.duracionReserva');
      const horaFinInput = card.querySelector('.horaFin');

      function calcularHoraFin() {
        const horaInicio = horaInicioInput.value;
        const duracion = parseInt(duracionSelect.value);

        // Validación: duración sin hora inicio
        if (!horaInicio && !isNaN(duracion)) {
          alert("Por favor selecciona la hora de inicio antes de elegir la duración.");
          horaFinInput.value = "";
          duracionSelect.value = "";
          return;
        }

        if (horaInicio && !isNaN(duracion)) {
          const [hora, minuto] = horaInicio.split(":").map(Number);
          const inicioDate = new Date();
          inicioDate.setHours(hora, minuto, 0);

          const finDate = new Date(inicioDate);
          finDate.setMinutes(finDate.getMinutes() + duracion);

          const horaCierre = new Date();
          horaCierre.setHours(23, 0, 0);

          if (finDate > horaCierre) {
            alert("La hora de fin no puede superar las 23:00.");
            horaFinInput.value = "";
            return;
          }

          const horaFin = finDate.toTimeString().slice(0, 5);
          horaFinInput.value = horaFin;
        } else {
          horaFinInput.value = "";
        }
      }

      // Escuchar eventos
      horaInicioInput.addEventListener('change', calcularHoraFin);
      duracionSelect.addEventListener('change', calcularHoraFin);
    });
  });
// Lógica para seleccionar horas
/*const hours = document.querySelectorAll('.hour.available');
hours.forEach(hour => {
  hour.addEventListener('click', function() {
    this.classList.toggle('selected'); // Cambia el estado al hacer clic
    if (this.classList.contains('selected')) {
      this.style.backgroundColor = '#17a2b8'; // Azul para mostrar la selección
    } else {
      this.style.backgroundColor = '#28a745'; // Verde cuando se deselecciona
    }
  });
});*/
// Función para manejar la selección del horario
document.addEventListener("DOMContentLoaded", function() {
  document.querySelectorAll(".hour").forEach(button => {
    button.addEventListener("click", function() {
      const selectedHour = this.getAttribute("data-time");
      // Aquí calculamos la hora de fin
      const endTime = calculateEndTime(selectedHour);
      document.getElementById("startTime").value = selectedHour + ":00";  // Hora de inicio
      document.getElementById("endTime").value = endTime;  // Hora de fin
    });
  });
});

// Función para calcular la hora de fin
function calculateEndTime(startTime) {
  const start = parseInt(startTime.split(":")[0]); // Convertir a entero
  const end = start + 1; // Por defecto, la duración es de 1 hora
  return `${end}:00`;
}
// modal horario
document.getElementById("fechaSelect").addEventListener("change", function() {
  let fechaSeleccionada = this.value;
  let idLocal = 15; // Este valor debe ser dinámico según el local

  // Llamada al backend para obtener los horarios disponibles para esa fecha
  fetch(`/obtener_horas_disponibles?fecha=${fechaSeleccionada}&idLocal=${idLocal}`)
    .then(response => response.json())
    .then(data => {
      let turnos = data.turnos;
      mostrarHoras(turnos);
    });
});

// Función para mostrar las horas en el modal
function mostrarHoras(turnos) {
  let container = document.getElementById("turnosContainer");
  container.innerHTML = ''; // Limpiar los turnos anteriores

  turnos.forEach(turno => {
    let turnoElement = document.createElement('div');
    turnoElement.classList.add('turno');

    let turnoHeader = document.createElement('h6');
    turnoHeader.textContent = `${turno.nombre} (${turno.inicio} - ${turno.fin})`;
    turnoElement.appendChild(turnoHeader);

    // Mostrar las horas disponibles
    let hoursContainer = document.createElement('div');
    hoursContainer.classList.add('hours');
    turno.horas.forEach(hora => {
      let button = document.createElement('button');
      button.classList.add('hour');
      button.textContent = hora;
      button.setAttribute('data-time', hora);
      button.addEventListener("click", function() {
        // Al hacer click, la hora cambia de estado (disponible a seleccionada)
        this.classList.toggle("seleccionado");
      });
      hoursContainer.appendChild(button);
    });

    turnoElement.appendChild(hoursContainer);
    container.appendChild(turnoElement);
  });
}



//seleccionar fecha
document.addEventListener("DOMContentLoaded", function () {
  // Inicialización de fechas en cada .fechaReserva
  document.querySelectorAll('.fechaReserva').forEach(select => {
    generarFechasParaSelect(select); // Genera fechas en cada tarjeta
  });

  // Actualiza cada 60 segundos por si cambia el día
  setInterval(() => {
    const ahora = new Date();
    ahora.setHours(0, 0, 0, 0);

    if (ahora.getTime() !== fechaBase.getTime()) {
      fechaBase = ahora;
      document.querySelectorAll('.fechaReserva').forEach(select => {
        generarFechasParaSelect(select);
      });
    }
  }, 60000);
});

// Función global
let fechaBase = new Date();
fechaBase.setHours(0, 0, 0, 0);

// Función que llena fechas en un <select>
function generarFechasParaSelect(select) {
  select.innerHTML = '';

  for (let i = 0; i <= 4; i++) {
    const fecha = new Date();
    fecha.setDate(fecha.getDate() + i);

    const yyyy = fecha.getFullYear();
    const mm = String(fecha.getMonth() + 1).padStart(2, '0');
    const dd = String(fecha.getDate()).padStart(2, '0');
    const valor = `${yyyy}-${mm}-${dd}`;
    const visible = `${dd}/${mm}/${yyyy}`;

    const opcion = document.createElement('option');
    opcion.value = valor;
    opcion.textContent = visible;
    select.appendChild(opcion);
  }
}

</script>
<script>
  // Suponiendo que cancha_caracteristicas es un diccionario de características por cancha
  
  
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap" rel="stylesheet">
{% endblock %}

{% block scripts%}
<script src="/static/assets/js/login.js"></script>
{% endblock%}
