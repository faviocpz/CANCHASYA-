{% extends 'base.html' %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='assets/css/cancha.css') }}">

<div class="container">
  <!-- Cabecera mejorada -->
  <div class="header">
    <h1 class="fw-bold text-center">{{ local_info[0][0] }}</h1>

    <!-- Card con imagen y datos del local, ahora con clase 'header-card' -->
    <!-- Card con imagen y datos del local, ahora con clase 'header-card' -->
<div class="info-container shadow p-3 mb-4">
  
    <!-- Imagen Banner al costado izquierdo -->
    <div class="banner-box">
      <img src="{{ url_for('static', filename='assets/img/' + local_info[0][6]) }}" alt="Banner del Local" class="banner-img">
    </div>
    
    <!-- Información del local al costado derecho -->
    <div class="local-info ms-4">
      <p><strong>Dirección:</strong> {{ local_info[0][1] }}</p>
      <p><strong>Correo Electrónico:</strong> {{ local_info[0][2] }}</p>
      <p><strong>Teléfono:</strong> {{ local_info[0][3] }}</p>
      <!--<div class="social-links">
        <p><strong>Redes Sociales:</strong></p>
        <p><strong>Facebook:</strong> ElEsfericoFutbol</p>
        <p><strong>Instagram:</strong> @elesfericofutbol</p>
      </div>-->
      <div class="social-buttons">
        <a href="https://www.facebook.com/{{ local_info[0][4] }}" class="facebook" target="_blank">
          <i class="bi bi-facebook"></i> Facebook
        </a>
        <a href="https://www.instagram.com{{ local_info[0][5] }}" class="instagram" target="_blank">
          <i class="bi bi-instagram"></i> Instagram
        </a>
      </div>
      <div class="turno-box">
        <h5>Turnos:</h5>
        {% for turno in turnos_info %}
        <p><strong>{{ turno[0] }}:</strong> {{ turno[1] }} - {{ turno[2] }}</p>
        {% endfor %}
      </div>
   
  </div>

</div>

  </div>
  <div class="text-center mb-4">
    <h2 class="text-primary fw-bold">Canchas Disponibles</h2>
  </div>


  <div class="row g-4 pb-5">
  {% for cancha in canchas_info %}
  <div class="col-12">
    <div class="card reserva-card flex-md-row shadow">
      <!-- Carrusel de imágenes al lado izquierdo -->
      <div class="col-md-7 p-0">
        <div id="carouselCancha{{ cancha[0] }}" class="carousel slide h-100" data-bs-ride="carousel">
          <div class="carousel-inner h-100">
            {% for foto in canchas_fotos[cancha[0]] %}
            <div class="carousel-item {% if loop.first %} active {% endif %} h-100">
              <img src="{{ url_for('static', filename='assets/img/' ~ foto) }}" class="d-block w-100 h-100" alt="Imagen de la cancha">
            </div>
            {% endfor %}
          </div>
          <button class="carousel-control-prev" type="button" data-bs-target="#carouselCancha{{ cancha[0] }}" data-bs-slide="prev">
            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Anterior</span>
          </button>
          <button class="carousel-control-next" type="button" data-bs-target="#carouselCancha{{ cancha[0] }}" data-bs-slide="next">
            <span class="carousel-control-next-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Siguiente</span>
          </button>
        </div>
      </div>

      <!-- Información de la cancha al lado derecho -->
      <div class="col-md-5 p-4 d-flex flex-column">
        <blockquote style="font-style: italic; color: #2c3e50; border-left: 4px solid #2980b9; padding-left: 10px;">
          {{ cancha[1] }}
        </blockquote>
        <h3><strong>{{ cancha[1] }}</strong></h3>

        <p><strong>Puntuación:</strong> 
          {% set rating = cancha[2] %}
          {% set full_stars = rating | int %}
          {% set half_star = (rating - full_stars) >= 0.5 %}
          {% for i in range(1, full_stars + 1) %}
            <i class="bi bi-star-fill text-warning"></i>
          {% endfor %}
          {% if half_star %}
            <i class="bi bi-star-half text-warning"></i>
          {% endif %}
          {% for i in range(full_stars + 1 + (1 if half_star else 0), 6) %}
            <i class="bi bi-star text-warning"></i>
          {% endfor %}
        </p>

        <p><strong>Precio por hora - Turno Mañana:</strong> S/. {{ cancha[3] }}</p>
        <p><strong>Precio por hora - Turno Tarde:</strong> S/. {{ cancha[4] }}</p>
        <p><strong>Precio por hora - Turno Noche:</strong> S/. {{ cancha[5] }}</p>

        <!--<div class="form-group">
          <label for="dateSelect">Selecciona una fecha:</label>
          <select class="form-control fechaReserva"></select>
        </div>-->

        <div class="mt-3">
          <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#scheduleModal">Horas Disponibles</button>
        </div>

        <div class="form-group mt-3">
          <label for="startTime">Hora de inicio:</label>
          <input type="time" id="startTime" class="form-control" disabled>
        </div>

        <div class="form-group mt-2">
          <label for="endTime">Hora de fin:</label>
          <input type="time" id="endTime" class="form-control" disabled>
        </div>

        <div class="caracteristicas mt-3">
          <button class="btn btn-info" onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none'">
            Cuenta con:
          </button>
          <ul style="display: none; margin-top: 5px;">
            {% for caracteristica in cancha_caracteristicas[cancha[0]] %}
              <li>{{ caracteristica }}</li>
            {% endfor %}
          </ul>
        </div>

        <div class="mt-auto pt-3 d-grid gap-2">
          <a href="javascript:void(0);" id="whatsappBtn" class="btn btn-whatsapp">
            <i class="bi bi-whatsapp me-1"></i> Contactar por WhatsApp
          </a>
          <button class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#puntuacionModal3" data-id="{{ cancha[0] }}" data-bs-dismiss="modal">
            <i class="bi bi-star me-1"></i> Añadir Puntuación
          </button>
        </div>
      </div>
    </div>
  </div>
  {% endfor %}
</div>
 
<!-- Modal HTML -->
<!-- Modal HTML -->
<!-- Modal HTML -->
<div class="modal fade" id="puntuacionModal3" tabindex="-1" aria-labelledby="puntuacionModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="POST" action="{{ url_for('registrar_puntuacion') }}" id="puntuacionForm">
        <div class="modal-header">
          <h5 class="modal-title" id="puntuacionModalLabel1">Puntuar Cancha</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <label for="puntuacion" class="form-label">Elige tu puntuación</label>
          <select class="form-select" name="puntuacion" id="puntuacion">
            <option value="1">⭐</option>
            <option value="2">⭐⭐</option>
            <option value="3">⭐⭐⭐</option>
            <option value="4">⭐⭐⭐⭐</option>
            <option value="5">⭐⭐⭐⭐⭐</option>
          </select>
        </div>
        <!-- Campo oculto para el idCancha -->
        <input type="hidden" name="idCancha" id="idCanchaInput"> <!-- Este es el campo que se actualiza dinámicamente -->
        <input type="hidden" name="idLocal" id="idLocalInput">
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Enviar</button>
        </div>
      </form>
    </div>
  </div>
</div>




<!-- Success message for confirmation -->
<div id="confirmationMessage" class="alert alert-success mt-3" style="display: none;">
  ¡Puntuación registrada correctamente!
</div>


<!-- Modal para mostrar los horarios -->
<div class="modal fade" id="scheduleModal" tabindex="-1" aria-labelledby="scheduleModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="scheduleModalLabel">Seleccionar Horario Disponible de Reserva</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        
        <!-- Horario de turno (Mañana, Tarde, Noche) -->
         <!-- Seleccionar la fecha -->
          
           <div class="form-group">
            <label for="fechaSelect">Selecciona la fecha:</label>
            <select class="form-control" id="modalFechaSelect"></select>
          </div> 
          
        <div id="turnosContainer" class="schedule mt-3">
          <!--{% for turno in turnos_info %}
          <div class="turno">
            <h6>{{ turno[0] }} ({{ turno[1] }} - {{ turno[2] }})</h6>
            <div class="hours">
              {% set start_hour = turno[1]|int %}
              {% set end_hour = turno[2]|int %}
              {% for hour in range(start_hour, end_hour) %}
                <button class="hour {% if hour in ocupadas %}ocupado{% else %}disponible{% endif %}" data-time="{{ hour }}">
                  {{ hour }}:00
                </button>
              {% endfor %}
            </div>
          </div>
           {% endfor %}-->
           
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        <button type="button" id="confirmarHorario" class="btn btn-primary" data-bs-dismiss="modal">Confirmar Horario</button>
      </div>
    </div>
  </div>
</div>

  </div>

  <div class="text-center my-4">
    <button class="btn btn-outline-primary mt-2" onclick="window.history.back();">← Regresar</button>
  </div>
</div>
<script>
document.addEventListener("DOMContentLoaded", function () {
    // 1. Llenar opciones de duración en todos los selects
    document.querySelectorAll('.duracionReserva').forEach(select => {
      for (let min = 20; min <= 120; min += 10) {
        const option = document.createElement("option");
        option.value = min;
        option.textContent = `${min} minutos`;
        select.appendChild(option);
      }
    });

    // 2. Escuchar cambios en cada tarjeta (card)
    document.querySelectorAll('.reserva-card').forEach(card => {
      const horaInicioInput = card.querySelector('.horaInicio');
      const duracionSelect = card.querySelector('.duracionReserva');
      const horaFinInput = card.querySelector('.horaFin');

      function calcularHoraFin() {
        const horaInicio = horaInicioInput.value;
        const duracion = parseInt(duracionSelect.value);

        // Validación: duración sin hora inicio
        if (!horaInicio && !isNaN(duracion)) {
          alert("Por favor selecciona la hora de inicio antes de elegir la duración.");
          horaFinInput.value = "";
          duracionSelect.value = "";
          return;
        }

        if (horaInicio && !isNaN(duracion)) {
          const [hora, minuto] = horaInicio.split(":").map(Number);
          const inicioDate = new Date();
          inicioDate.setHours(hora, minuto, 0);

          const finDate = new Date(inicioDate);
          finDate.setMinutes(finDate.getMinutes() + duracion);

          const horaCierre = new Date();
          horaCierre.setHours(23, 0, 0);

          if (finDate > horaCierre) {
            alert("La hora de fin no puede superar las 23:00.");
            horaFinInput.value = "";
            return;
          }

          const horaFin = finDate.toTimeString().slice(0, 5);
          horaFinInput.value = horaFin;
        } else {
          horaFinInput.value = "";
        }
      }

      // Escuchar eventos
      horaInicioInput.addEventListener('change', calcularHoraFin);
      duracionSelect.addEventListener('change', calcularHoraFin);
    });
  });
// Lógica para seleccionar horas
/*const hours = document.querySelectorAll('.hour.available');
hours.forEach(hour => {
  hour.addEventListener('click', function() {
    this.classList.toggle('selected'); // Cambia el estado al hacer clic
    if (this.classList.contains('selected')) {
      this.style.backgroundColor = '#17a2b8'; // Azul para mostrar la selección
    } else {
      this.style.backgroundColor = '#28a745'; // Verde cuando se deselecciona
    }
  });
});*/
// Función para manejar la selección del horario
document.addEventListener("DOMContentLoaded", function() {
  document.querySelectorAll(".hour").forEach(button => {
    button.addEventListener("click", function() {
      const selectedHour = this.getAttribute("data-time");
      // Aquí calculamos la hora de fin
      const endTime = calculateEndTime(selectedHour);
      document.getElementById("startTime").value = selectedHour + ":00";  // Hora de inicio
      document.getElementById("endTime").value = endTime;  // Hora de fin
    });
  });
});

// Función para calcular la hora de fin
function calculateEndTime(startTime) {
  const start = parseInt(startTime.split(":")[0]); // Convertir a entero
  const end = start + 1; // Por defecto, la duración es de 1 hora
  return `${end}:00`;
}
// MODAL HORARIO
function obtenerIdLocalDesdeURL() {
  const path = window.location.pathname; // e.g. /local/50
  const partes = path.split('/');
  const idLocal = partes[partes.length - 1]; // obtiene '50'
  return idLocal;
}
let horaSeleccionadaInicio = null;
let horaSeleccionadaFin = null;

document.getElementById("modalFechaSelect").addEventListener("change", function() {
  let fechaSeleccionada = this.value;
  let idLocal = obtenerIdLocalDesdeURL(); // Este valor debe ser dinámico según el local

  // Llamada al backend para obtener los horarios disponibles para esa fecha
  fetch(`/obtener_horas_disponibles?fecha=${fechaSeleccionada}&idLocal=${idLocal}`)
    .then(response => response.json())
    .then(data => {
      let turnos = data.turnos;
      mostrarHoras(turnos);
    });
});

// Función para mostrar las horas en el modal
function mostrarHoras(turnos) {
  let container = document.getElementById("turnosContainer");
  container.innerHTML = ''; // Limpiar los turnos anteriores

  turnos.forEach(turno => {
    let turnoElement = document.createElement('div');
    turnoElement.classList.add('turno');

    let turnoHeader = document.createElement('h6');
    turnoHeader.textContent = `${turno.nombre} (${turno.inicio} - ${turno.fin})`;
    turnoElement.appendChild(turnoHeader);

    // Mostrar las horas disponibles
    let hoursContainer = document.createElement('div');
    hoursContainer.classList.add('hours');
    turno.horas.forEach(hora => {
      let button = document.createElement('button');
      button.classList.add('hour');
      button.textContent = hora;
      button.setAttribute('data-time', hora);
     
      button.addEventListener("click", function() {
        // Al hacer click, la hora cambia de estado (disponible a seleccionada)
        this.classList.toggle("seleccionado");
        // Si la hora es seleccionada, actualizamos la hora seleccionada
          if (this.classList.contains('seleccionado')) {
            if (!horaSeleccionadaInicio) {
              // Si no se ha seleccionado hora de inicio, la guardamos como inicio
              horaSeleccionadaInicio = hora;
            } else {
              // Si ya se ha seleccionado la hora de inicio, la guardamos como fin
              horaSeleccionadaFin = hora;
            }
          } else {
            // Si la hora es deseleccionada, la eliminamos
            if (horaSeleccionadaInicio === hora) {
              horaSeleccionadaInicio = null;
            }
            if (horaSeleccionadaFin === hora) {
              horaSeleccionadaFin = null;
            }
          }
        // Cargar la hora seleccionada en los campos de hora de inicio y fin
        /*let horaInicio = hora.split(":")[0];  // Obtener solo la hora (sin minutos)
        let horaFin = (parseInt(horaInicio) + 1) % 24; // Aquí puedes personalizar la duración que desees (ej. +1 hora)

        document.getElementById("startTime").value = horaInicio + ":00"; // Hora de inicio
        document.getElementById("endTime").value = horaFin + ":00"; // Hora de fin*/
      });
      hoursContainer.appendChild(button);
    });

    turnoElement.appendChild(hoursContainer);
    container.appendChild(turnoElement);
  });
}

// Función para confirmar la hora seleccionada
document.getElementById("confirmarHorario").addEventListener("click", function() {
  if (horaSeleccionadaInicio && horaSeleccionadaFin) {
    // Si se han seleccionado ambas horas, actualizamos los campos
    document.getElementById("startTime").value = horaSeleccionadaInicio + ":00";
    document.getElementById("endTime").value = horaSeleccionadaFin + ":00";
   
  } else {
    alert("Por favor, selecciona un rango de hora válido.");
  }
});
document.addEventListener("DOMContentLoaded", function() {
  // Establecer la fecha mínima para el selector de fecha
  const fechaSelect = document.getElementById("fechaSelect");
  const today = new Date();
  
  // Formatear la fecha en formato YYYY-MM-DD
  const formattedDate = today.toISOString().split('T')[0];
  
  // Establecer el atributo min del input para que no se puedan seleccionar fechas pasadas
  fechaSelect.setAttribute("min", formattedDate);
});

// MENSAJE WSP
// Seleccionar los elementos de fecha y hora
const fechaSelect = document.getElementById("modalFechaSelect");
const startTime = document.getElementById("startTime");
const endTime = document.getElementById("endTime");

// Botón de WhatsApp
const whatsappButton = document.getElementById("whatsappBtn");

// Actualiza el enlace de WhatsApp cuando se seleccione la fecha y las horas
document.getElementById("confirmarHorario").addEventListener("click", function() {
  // Obtener la fecha y horas seleccionadas
  const fechaSeleccionada = fechaSelect.value;
  const horaInicio = startTime.value;
  const horaFin = endTime.value;

  if (fechaSeleccionada && horaInicio && horaFin) {
    // Construir el mensaje de WhatsApp con la información seleccionada
    const mensaje = `Hola, quiero reservar la cancha del local para el día ${fechaSeleccionada}. Hora de inicio: ${horaInicio}. Hora de fin: ${horaFin}.`;

    // Codificar el mensaje para ser usado en la URL
    const mensajeCodificado = encodeURIComponent(mensaje);

    // Establecer el enlace dinámico de WhatsApp
    whatsappButton.setAttribute("href", `https://wa.me/{{ local_info[0][7] }}?text=${mensajeCodificado}`);
  } else {
    alert("Por favor, selecciona una fecha y las horas de inicio y fin.");
  }
});
//confirmacion puntuacion
// Este JavaScript asegura que el modal reciba el idCancha correcto
document.querySelectorAll('[data-bs-target="#puntuacionModal3"]').forEach(button => {
  button.addEventListener('click', function() {
    var idCancha = this.getAttribute('data-id'); // Capturamos el idCancha
    document.getElementById('idCanchaInput').value = idCancha; // Asignamos el idCancha al input oculto
    let idLocal1 = obtenerIdLocalDesdeURL();
    document.getElementById('idLocalInput').value = idLocal1;
  });
});







//------------------
//seleccionar fecha
document.addEventListener("DOMContentLoaded", function () {
generarFechasParaSelect(document.getElementById("modalFechaSelect"));
  // Inicialización de fechas en cada .fechaReserva
  document.querySelectorAll('.fechaReserva').forEach(select => {
    generarFechasParaSelect(select); // Genera fechas en cada tarjeta
  });

  // Actualiza cada 60 segundos por si cambia el día
  setInterval(() => {
    const ahora = new Date();
    ahora.setHours(0, 0, 0, 0);

    if (ahora.getTime() !== fechaBase.getTime()) {
      fechaBase = ahora;
      document.querySelectorAll('.fechaReserva').forEach(select => {
        generarFechasParaSelect(select);
      });
    }
  }, 60000);
});

// Función global
let fechaBase = new Date();
fechaBase.setHours(0, 0, 0, 0);

// Función que llena fechas en un <select>
function generarFechasParaSelect(select) {
  select.innerHTML = '';

  for (let i = 0; i <= 4; i++) {
    const fecha = new Date();
    fecha.setDate(fecha.getDate() + i);

    const yyyy = fecha.getFullYear();
    const mm = String(fecha.getMonth() + 1).padStart(2, '0');
    const dd = String(fecha.getDate()).padStart(2, '0');
    const valor = `${yyyy}-${mm}-${dd}`;
    const visible = `${dd}/${mm}/${yyyy}`;

    const opcion = document.createElement('option');
    opcion.value = valor;
    opcion.textContent = visible;
    select.appendChild(opcion);
  }
}

</script>
<script>
  // Suponiendo que cancha_caracteristicas es un diccionario de características por cancha
  
  
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap" rel="stylesheet">
{% endblock %}

{% block scripts%}
<script src="/static/assets/js/login.js"></script>
{% endblock%}
